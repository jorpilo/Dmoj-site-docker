#!/bin/bash

#Override local_settings
if [ -f /tmp/settings/local_settings.py ]; then
	ls /tmp
    cp /tmp/settings/local_settings.py /tmp/local_settings.py
else
	echo "Error file not found"
	exit 1
fi

envsubst < /tmp/local_settings.py > $DMOJ_PATH/dmoj/local_settings.py

while ! mysqladmin ping -h"$DB_HOST" --silent; do
    sleep 5
	echo "waiting for DB"
done
	  
#Activate virtenv
. /dmojsite/bin/activate

# create DB and transfer
python3 $DMOJ_PATH/manage.py migrate
if [ "${POPULATE}" = "True" ]; then /populate.sh; fi

echo "Checking"
python3 $DMOJ_PATH/manage.py check || exit 1
echo "runbridged"
python3 $DMOJ_PATH/manage.py runbridged || exit 1

if [ "${DEBUG}" = "True" ]; then 
  echo "Testing mode"
  python $DMOJ_PATH/manage.py runserver ${DMOJ_HOST}:${DMOJ_PORT}
fi



